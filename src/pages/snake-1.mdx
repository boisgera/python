---
title: The Snake Game
author: "[S√©bastien Boisg√©rault](mailto:Sebastien.Boisgerault@minesparis.psl.eu), 
ITN, Mines Paris -- PSL"
license: "[CC BY 4.0](https://creativecommons.org/licenses/by/4.0/)"
layout: ../layouts/MDXLayout.astro
---

export const debug = true;

import Admonition from "/src/components/Admonition.astro";
import { Image } from "astro:assets";


## Test

(doesn't work right now)

```python title="imports.py" del={1} ins={2-3}
import pyxel
import time
import keyboard
import new
```

import snake from "/src/assets/snake.jpg";

<Image src={snake} alt="Boa constrictor by Jan Kop≈ôiva" />

Projet original par Aur√©lien Noce (aka [@ushu](https://github.com/ushu)).

{/* ## Table des mati√®res */}

## Introduction

Ce TP vous propose de d√©velopper un petit jeu en Python.
Il constitue une introduction √† la conception et √† la r√©alisation
d'un programme complet.

Son sujet est un standard du jeu vid√©o, le üêç [snake].

[[üéÆ Snake!](https://kitao.github.io/pyxel/wasm/examples/07_snake.html) ;
une version classique du snake, r√©alis√©e avec la plate-forme de retro-gaming
Python [Pyxel](https://github.com/kitao/pyxel).](images/snake-pyxel.jpg)

De nombreuses variantes de ce jeu existent ; [slither.io](https://slither.io)
est un bon exemple de snake modernis√© (et notamment, massivement multijoueur !).

[snake]: https://fr.wikipedia.org/wiki/Snake_(genre_de_jeu_vid%C3%A9o)

Rassurez-vous, notre objectif sera modeste et donc proche de la version
classique du jeu : nous r√©aliserons plusieurs versions d'un **programme qui marche**
(et pas un programme parfait) dont les fonctionnalit√©s s'enrichiront √†
chaque nouvelle √©tape.

## Getting started

Let's start with a message display whose color changes over time.

<video controls width="768">
  <source src="../videos/hello-snake.webm" type="video/webm" />
</video>

The code of this application is:

```python
import pyxel

def update():
    if pyxel.btnp(pyxel.KEY_Q):
        pyxel.quit()

def draw():
    pyxel.cls(0)
    color = pyxel.frame_count % 16
    pyxel.text(56, 54, "Hello, Snake!", color)

pyxel.init(160, 120)
pyxel.run(update, draw)
```

Now we are going to slightly tweak this program until we understand 
what's going on. 
When it's necessary, search into Pyxel's [user's guide] and [reference 
documentation].

[user's guide]: https://github.com/kitao/pyxel#how-to-uses
[reference documentation]: https://github.com/kitao/pyxel#api-reference


import palette from "/src/assets/pyxel-color-palette.png";

### Colors

Can you display the message in black on a white background instead?



<Admonition type="solution" open={debug}>
In the spirit of retro gaming, Pyxel can only display 16 colors.
The standard palette from which you must pick your color is described [here][palette].

<Image src={palette} alt="Pyxel's color palette" style="margin:auto;display:block;"/>


The index of black is `0` and there is no pure white, but the closest is color
`7`. 
Therefore, the changes we need to perform are:

[palette]: https://github.com/kitao/pyxel#color-palette


```python
def draw():
    pyxel.cls(7)
    pyxel.text(56, 54, "Hello, Snake!", 1)
```
</Admonition>

[API]: https://github.com/kitao/pyxel#api-reference

### Text & Geometry

- Text: comprendre la taille (fixe) de chaque caract√®re,
  display d'une "grille" de caract√®res., comprendre comment est
  plac√© le "Hello world!", ajuster le programme pour que le texte
  soit toujours centr√© (m√™me si plusieurs lignes ?).

- Message translating from the right to the left?

### Frame rate

The `time` function from the `time` module of the Python standard library
returns the time elapsed in seconds since January 1st, 1970 at noon.

```
>>> import time
>>> time.time()
1692980870.0990813
>>> time.time()
1692980871.2445116
>>> time.time()
1692980872.3245282
```

Use this function to measure the time elapsed between two calls to the `draw`
function of Pyxel. Then, print the (approximate) number of frames per second 
(FPS) in window top left corner.

<video controls width="768">
  <source src="../videos/fps.webm" type="video/webm" />
</video>

<Admonition type="solution" open={debug}>
```python
import pyxel
import time

def update():
    if pyxel.btnp(pyxel.KEY_Q):
        pyxel.quit()

def draw():
    global t
    t_new = time.time()
    dt = t_new - t
    t = t_new
    fps = 1.0 / dt
    fps = int(round(fps))
    pyxel.cls(0)
    color = pyxel.frame_count % 16
    pyxel.text(56, 54, "Hello, Snake!", color)
    pyxel.text(0, 0, f"fps: {fps}", 7)
```
</Admonition>

## The Game Board

Let's build a game board

- made of a square of 30x30 cells,

- with each cell is 1 pixel large.

<Admonition type="question" label="Don't you think that 1 pixel is too small?">
Yes, it certainly would be if we were talking about real pixels! 
But luckily for us, Pyxel automatically scales the display to fit the screen size. 
Since we use a small display, it will zoom it quite a bit and we will be able to see every "pixel" clearly.
</Admonition>

To check that everything's ok, draw a checkerboard pattern like this:

import checkerboard from "/src/assets/checkerboard.png";

<Image src={checkerboard} alt="A 30x30 checkerboard" />

We will keep this checkerboard in the background as "training wheels" for a 
while, and remove it at the very last step.

<Admonition type="solution" open={debug}>
```python
import pyxel
import random

def update():
    if pyxel.btnp(pyxel.KEY_Q):
        pyxel.quit()

fruit = [
    random.randint(0, 29), 
    random.randint(0, 29)
]

def draw():
    pyxel.cls(13) 
    for i in range(30):
        for j in range(30):
            if (i+j) % 2 == 0:
                pyxel.pset(i, j, 7) 
    pyxel.pset(fruit[0], fruit[1], 8)

pyxel.init(30, 30)
pyxel.run(update, draw)
```
</Admonition>

## The (Forbidden) Fruit

Display a fruit at a random location on top of the checkerboard.
A fruit is a simple 1x1 rectangle (a pixel!). Pick a color you like !
When we say "random", we want the fruit location to be different each time
you restart the program.


import fruit from "/src/assets/fruit.png";

<Image src={fruit} alt="A fruit at a random location" />

<Admonition type="solution" open={debug}>
```python
import pyxel 
import random

def update():
    if pyxel.btnp(pyxel.KEY_Q):
        pyxel.quit()

fruit = [
    random.randint(0, 29), 
    random.randint(0, 29)
]

def draw():
    pyxel.cls(13)
    for i in range(30):
        for j in range(30):
            if (i+j) % 2 == 0:
                pyxel.pset(i, j, 7) 
    pyxel.pset(fruit[0], fruit[1], 8)

pyxel.init(30, 30)
pyxel.run(update, draw)
```
</Admonition>

## A Restin' Snake

In the next step, we will represent the snake, as a sequence of pixels.
Let's snake with the following simple sequence

```python
snake_geometry = [
    [10, 15],
    [11, 15],
    [12, 15],
]
```

Let's say that `[12, 15]` is the snake head.
Use a dark green color to represent the snake body and a light green 
for its head.


import restingSnake from "/src/assets/resting-snake.png";

<Image src={restingSnake} alt="A resting snake" />


<Admonition type="solution" open={debug} >

```python
import pyxel
import random

fruit = [
    random.randint(0, 29), 
    random.randint(0, 29)
]

snake_geometry = [
    [10, 15],
    [11, 15],
    [12, 15],
]

def update():
    if pyxel.btnp(pyxel.KEY_Q):
        pyxel.quit()

def draw():
    pyxel.cls(7)
    for i in range(30):
        pyxel.cls(13)
        for j in range(30):
            if (i+j) % 2 == 0:
                pyxel.pset(i, j, 7) 
    pyxel.pset(fruit[0], fruit[1], 8)
    for x, y in snake_geometry[:-1]:
        pyxel.pset(x, y, 3)
    head = snake_geometry[-1]
    pyxel.pset(head[0], head[1], 11)

pyxel.init(30, 30)
pyxel.run(update, draw)
```
</Admonition>

## Events

**TODO.** Checkerboard off by default, on/off with "C" key

<video controls width="768">
  <source src="../videos/checkerboard-on-off.webm" type="video/webm" />
</video>


<Admonition type="solution" open={debug} >

```python
import pyxel
import random

fruit = [
    random.randint(0, 29), 
    random.randint(0, 29)
]

snake_geometry = [
    [10, 15],
    [11, 15],
    [12, 15],
]

checkerboard = False

def update():
    global checkerboard
    if pyxel.btnp(pyxel.KEY_Q):
        pyxel.quit()
    if pyxel.btnp(pyxel.KEY_C):
        checkerboard = not checkerboard

def draw():
    pyxel.cls(7)
    if checkerboard:
        pyxel.cls(13)
        for i in range(30):
            for j in range(30):
                if (i+j) % 2 == 0:
                    pyxel.pset(i, j, 7) 
    pyxel.pset(fruit[0], fruit[1], 8)
    for x, y in snake_geometry[:-1]:
        pyxel.pset(x, y, 3)
    head = snake_geometry[-1]
    pyxel.pset(head[0], head[1], 11)

pyxel.init(30, 30)
pyxel.run(update, draw)
```
</Admonition>

**TODO.** Modify the program so that when the user presses the arrow keys,
the program displays (with the `print` function) the characters `‚Üê`, `‚Üë`, `‚Üí`
or `‚Üì` in the terminal.


<Admonition type="solution" open={debug}>

```python
import pyxel
import random

fruit = [
    random.randint(0, 29), 
    random.randint(0, 29)
]

snake_geometry = [
    [10, 15],
    [11, 15],
    [12, 15],
]

checkerboard = False

arrow_keys = [
    pyxel.KEY_UP, 
    pyxel.KEY_DOWN, 
    pyxel.KEY_LEFT, 
    pyxel.KEY_RIGHT
]

def update():
    global checkerboard
    if pyxel.btnp(pyxel.KEY_Q):
        pyxel.quit()
    if pyxel.btnp(pyxel.KEY_C):
        checkerboard = not checkerboard
    arrow_keys_pressed = []
    for key in arrow_keys:
        if pyxel.btnp(key):
            arrow_keys_pressed.append(key)
    for key in arrow_keys_pressed:
        if key == pyxel.KEY_UP:
            print("‚Üë")
        elif key == pyxel.KEY_DOWN:
            print("‚Üì")
        elif key == pyxel.KEY_LEFT:
            print("‚Üê")   
        elif key == pyxel.KEY_RIGHT:
            print("‚Üí")

def draw():
    pyxel.cls(7)
    if checkerboard:
        pyxel.cls(13)
        for i in range(30):
            for j in range(30):
                if (i+j) % 2 == 0:
                    pyxel.pset(i, j, 7) 
    pyxel.pset(fruit[0], fruit[1], 8)
    for x, y in snake_geometry[:-1]:
        pyxel.pset(x, y, 3)
    head = snake_geometry[-1]
    pyxel.pset(head[0], head[1], 11)

pyxel.init(30, 30)
pyxel.run(update, draw)
```
</Admonition>




## It's Aliiiiiiive!

Ensuite, nous allons faire bouger le serpent :

- nous cr√©ons un vecteur de "direction", par exemple

  ```python
  snake_direction = [1, 0]
  ```

- √† chaque it√©ration de la boucle, nous pouvons d√©placer le serpent dans
  cette direction en "ajoutant" ce vecteur √† la position de la t√™te du serpent

{/* ![](images/serpent-bouge.gif) */}

Une fois que le serpent bouge, ajouter les commandes pour se d√©placer dans
les 4 directions, en appuyant sur les touches de direction du clavier.

Aussi on peut commencer √† envisager d'acc√©l√©rer un peu le jeu √† ce stade ...

**Bonus.** Faites en sorte que le serpent ne puisse pas faire demi-tour.

<Admonition type="solution" open={debug} >


```python
import sys
import pygame

white = [255, 255, 255]
black = [0, 0, 0]
snake = [
    [10, 15],
    [11, 15],
    [12, 15],
]
direction = [1, 0]

pygame.init()
screen = pygame.display.set_mode([20*30, 20*30])
clock = pygame.time.Clock()
while True:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            pygame.quit()
            sys.exit()
        elif event.type == pygame.KEYDOWN:
            if event.key == pygame.K_q:
                pygame.quit()
                sys.exit()
            if event.key == pygame.K_UP:
                direction = [0.0, -1.0]
            elif event.key == pygame.K_LEFT:
                direction = [-1.0, 0.0]
            elif event.key == pygame.K_DOWN:
                direction = [0.0, 1.0]
            elif event.key == pygame.K_RIGHT:
                direction = [1.0, 0.0]
    head = snake[-1]
    new_head = [
      head[0] + direction[0],
      head[1] + direction[1]
    ]
    snake = snake[1:] + [new_head]
    screen.fill(white)
    for x, y in snake:
        rect = [x*20, y*20, 20, 20]
        pygame.draw.rect(screen, black, rect)
    pygame.display.update()
    clock.tick(1)
```

</Admonition>

## Le fruit

Il faut maintenant faire manger notre serpent.
On va proc√©der comme suit:

- on a toujours la position du serpent dans une variable `snake` :

- on g√©n√®re un "fruit", dans une position al√©atoire

  ```python
  fruit = [10, 10]
  ```

- quand la t√™te du serpent mange le fruit,
  on place un nouveau fruit √† une position al√©atoire
  et on allonge le serpent d'une case

  {/* ![](images/manger.gif) */}

<Admonition type="solution" open={debug} >



```python
import random
import sys
import pygame

white = [255, 255, 255]
black = [0, 0, 0]
red = [255, 0, 0]
snake = [
    [10, 15],
    [11, 15],
    [12, 15],
]
direction = [1, 0]
fruit = [10, 10]

pygame.init()
screen = pygame.display.set_mode([20*30, 20*30])
clock = pygame.time.Clock()
while True:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            pygame.quit()
            sys.exit()
        elif event.type == pygame.KEYDOWN:
            if event.key == pygame.K_q:
                pygame.quit()
                sys.exit()
            if event.key == pygame.K_UP:
                direction = [0, -1]
            elif event.key == pygame.K_LEFT:
                direction = [-1, 0]
            elif event.key == pygame.K_DOWN:
                direction = [0, 1]
            elif event.key == pygame.K_RIGHT:
                direction = [1, 0]
    head = snake[-1]
    new_head = [
      head[0] + direction[0],
      head[1] + direction[1]
    ]
    if new_head == fruit:
        snake = snake + [new_head]
        fruit = [
            random.randint(0, 29),
            random.randint(0, 29)
        ]
    else:
        snake = snake[1:] + [new_head]
    screen.fill(white)
    for x, y in snake:
        rect = [x*20, y*20, 20, 20]
        pygame.draw.rect(screen, black, rect)
    rect = [fruit[0]*20, fruit[1]*20, 20, 20]
    pygame.draw.rect(screen, red, rect)
    pygame.display.update()
    clock.tick(1)
```

</Admonition>

## √âpilogue

Il nous reste deux petits changements pour avoir un serpent compl√®tement
fonctionnel :

- Il faut d√©tecter si le serpent se mord la queue, ou touche un
  des murs, ce qui est une condition d'√©chec.

- Enfin on peut afficher le score.
  La fa√ßon la plus simple de proc√©der est de changer le titre de la fen√™tre,
  avec la fonction `set_caption` :

  ```python
  score = 0
  pygame.display.set_caption(f"üêç Score: {score}")
  ```

<Admonition type="solution" open={debug} >




```python
import random
import sys
import pygame

white = [255, 255, 255]
black = [0, 0, 0]
red = [255, 0, 0]
snake = [
    [10, 15],
    [11, 15],
    [12, 15],
]
direction = [1, 0]
fruit = [10, 10]
score = 0

pygame.init()
screen = pygame.display.set_mode([20*30, 20*30])
clock = pygame.time.Clock()
while True:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            pygame.quit()
            sys.exit()
        elif event.type == pygame.KEYDOWN:
            if event.key == pygame.K_q:
                pygame.quit()
                sys.exit()
            if event.key == pygame.K_UP:
                direction = [0, -1]
            elif event.key == pygame.K_LEFT:
                direction = [-1, 0]
            elif event.key == pygame.K_DOWN:
                direction = [0, 1]
            elif event.key == pygame.K_RIGHT:
                direction = [1, 0]
    head = snake[-1]
    new_head = [
      head[0] + direction[0],
      head[1] + direction[1]
    ]
    if (
        new_head in snake
        or new_head[0] < 0
        or new_head[0] >= 30
        or new_head[1] < 0
        or new_head[1] >= 30
    ):
        pygame.quit()
        sys.exit()
    if new_head == fruit:
        score = score + 1
        snake = snake + [new_head]
        fruit = [
            random.randint(0, 29),
            random.randint(0, 29)
        ]
    else:
        snake = snake[1:] + [new_head]
    screen.fill(white)
    for x, y in snake:
        rect = [x*20, y*20, 20, 20]
        pygame.draw.rect(screen, black, rect)
    rect = [fruit[0]*20, fruit[1]*20, 20, 20]
    pygame.draw.rect(screen, red, rect)
    pygame.display.update()
    pygame.display.set_caption(f"üêç Score: {score}")
    clock.tick(1)
```

</Admonition>
